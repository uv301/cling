name: Cling Build and Test

on:
  push:
    paths:
      - '**'
  workflow_dispatch:
  release:

jobs:
  build-cling:
    runs-on: ubuntu-latest
    name: Build on ${{ matrix.distro }} ${{ matrix.arch }}
    strategy:
      matrix:
        include:
          - {arch: x86_64, distro: ubuntu_latest}
          - {arch: x86, distro: ubuntu_latest}
          - {arch: aarch64, distro: ubuntu_latest}
          - {arch: armhf, distro: ubuntu_latest}
          - {arch: armv7, distro: ubuntu_latest}
          - {arch: ppc64le, distro: ubuntu_latest}
          - {arch: riscv64, distro: ubuntu_latest}
          - {arch: s390x, distro: ubuntu_latest}
    steps:
      - name: Checkout LLVM
        uses: actions/checkout@v4
        with:
          repository: root-project/llvm-project
          path: llvm
          ref: cling-latest
          fetch-depth: 1
          
      - name: Checkout Cling
        uses: actions/checkout@v4
        with:
          repository: root-project/cling
          path: cling
          fetch-depth: 1

      - name: Prepare build directory
        run: |
          mkdir build

      - name: Build
        uses: uraimo/run-on-arch-action@v3
        id: build
        with:
          arch: ${{ matrix.arch }}
          distro: ${{ matrix.distro }}
          #githubToken: ${{ github.token }}
          env: | # YAML, but pipe character is necessary
            artifact_name: cling-${{ matrix.distro }}_${{ matrix.arch }}
          setup: |
            mkdir -p "${PWD}/artifacts"
          dockerRunArgs: |
            --volume "${PWD}/artifacts:/artifacts"
            --volume "${PWD}/cling:/cling"
            --volume "${PWD}/llvm:/llvm"
          install: apt-get update && apt-get -y -q install cmake gcc g++ python3 ocaml-findlib libedit-dev zlib1g-dev libxml++2.6-dev git
          run: |
            mkdir -p "/artifacts/${artifact_name}" && mkdir /tmp/build
            PWD=/tmp/build cmake -DLLVM_EXTERNAL_PROJECTS=cling -DLLVM_EXTERNAL_CLING_SOURCE_DIR=/cling/ -DLLVM_ENABLE_PROJECTS="clang" -DLLVM_TARGETS_TO_BUILD="host;NVPTX" -DCMAKE_BUILD_TYPE=Release /llvm/llvm/
            PWD=/artifacts/${artifact_name} cmake --build /tmp/build --parallel 4 --target cling
            echo "Produced artifact at ${ls -lah /artifacts/${artifact_name}/}"
          
      #- name: Test
        #working-directory: build
        #run: cmake --build . --target check-cling

      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v4.6.2
        with:
    # Artifact name
          name: cling-${{ matrix.distro }}_${{ matrix.arch }}
    # A file, directory or wildcard pattern that describes what to upload
          path: artifacts/cling-${{ matrix.distro }}_${{ matrix.arch }}
    # The desired behavior if no files are found using the provided path.
